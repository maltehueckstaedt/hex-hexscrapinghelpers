# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# LOAD PACKAGES/FUNCTIONS ----------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
library(devtools)
pkgload::load_all()

# usethis::use_version("patch")  # erhöht z.B. von 1.0.0 auf 1.0.1
usethis::use_version("minor")  # erhöht z.B. von 1.0.0 auf 1.1.0
# usethis::use_version("major")  # erhöht z.B. von 1.0.0 auf 2.0.0

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# START DRIVER ---------------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

driver <- rsDriver(
  browser = "chrome",
  chromever = "latest",
  port = 1234L
)

rmdr <- driver[["client"]]
rmdr$maxWindowSize()

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# TEST FUNCTIONS ----------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test select_semester_and_set_courses & main function ----
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

rmdr <- rmdr
base_url <- "https:\\wuestudy.zv.uni-wuerzburg.de/qisserver/pages/startFlow.xhtml?_flowId=searchCourseNonStaff-flow&_flowExecutionKey=e4s1"
num_sem_selector <- 12
num_courses <- "10"
css_sem_dropdown <- "#genericSearchMask\\:search_e4ff321960e251186ac57567bec9f4ce\\:cm_exa_eventprocess_basic_data\\:fieldset\\:inputField_3_abb156a1126282e4cf40d48283b4e76d\\:idabb156a1126282e4cf40d48283b4e76d\\:termSelect_label"
css_search_field <- "#genericSearchMask\\:search_e4ff321960e251186ac57567bec9f4ce\\:cm_exa_eventprocess_basic_data\\:fieldset\\:inputField_0_1ad08e26bde39c9e4f1833e56dcce9b5\\:id1ad08e26bde39c9e4f1833e56dcce9b5"
num_courses_selector <- "#genSearchRes\\:id3df798d58b4bacd9\\:id3df798d58b4bacd9Navi2NumRowsInput"

 

select_semester_and_set_courses(
  rmdr,
  base_url,
  num_sem_selector,
  num_courses,
  css_sem_dropdown,
  css_search_field,
  num_courses_selector
)


css_selectors <- generate_url_selectors(rmdr, css_first_selector = "#genSearchRes\\:id3df798d58b4bacd9\\:id3df798d58b4bacd9Table\\:%d\\:tableRowAction")
chunks <- split(css_selectors, ceiling(seq_along(css_selectors) / 10))
chunks <- chunks[c("1", "2")]

ss19 <- scrape_his(chunks, rmdr, css_selectors)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test generate_url_selectors --------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

generate_url_selectors(rmdr, css_first_selector = "#genSearchRes\\:id3df798d58b4bacd9\\:id3df798d58b4bacd9Table\\:%d\\:tableRowAction")

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test click_course_url -----------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

i <- "#genSearchRes\\:id3df798d58b4bacd9\\:id3df798d58b4bacd9Table\\:9\\:tableRowAction > span"

click_course_url(i, rmdr, max_attempts = 10)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test scrape_termin -------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

scrape_termine(rmdr)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test scrape_inhalte -------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
scrape_inhalte(rmdr)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test scrape_module --------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||


scrape_module(rmdr)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test scrape_studiengaenge --------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

scrape_studiengaenge(rmdr)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test click_back --------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

click_back(rmdr)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test click_next_page ------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

click_next_page(rmdr)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test click_next_10_pages --------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

click_next_10_pages(rmdr)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
## test go_to_last_active_page -----------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

go_to_last_active_page(rmdr, 126)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# STOP SESSION --------------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

rmdr$close()
system("taskkill /im java.exe /f", intern = FALSE, ignore.stdout = FALSE)

# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# Check_Build Package --------------------------------------------
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

devtools::document()
devtools::check()
devtools::build(path = "C:/Users/mhu/Documents/gitlab/hex-hexscrapinghelpers")

usethis::use_version("patch")
